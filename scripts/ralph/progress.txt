## Codebase Patterns
- Use ESLint v9 flat config in `eslint.config.js`; `.eslintrc.*` is ignored.
- Keep ESLint parser settings non-project-bound in this mixed workspace unless every TS file is covered by tsconfig references.
- Keep client and server TypeScript configs separate (`src/client/tsconfig.json` and `src/server/tsconfig.json`) and validate both in `npm run typecheck`.
- For image previews, keep canonical upload state as `File[]` and always revoke `URL.createObjectURL(...)` values in cleanup.
- For file picker flows, reset the hidden input value after handling `onChange` so re-selecting the same file still triggers an event.
- For numeric settings inputs, keep React state as strings for controlled fields and validate/coerce at submit time before persistence.
- For localStorage-backed forms, coerce parsed JSON through a typed sanitizer before hydrating state, and fall back to safe defaults for missing/invalid fields.
- For server uploads, attach per-request session metadata to the Express request before Multer runs, and always clean up the session temp directory immediately on failed upload paths.
- In TypeScript, Multer `diskStorage.destination` callbacks must still pass the second `destination` argument even on error paths to satisfy callback typing.
- For long-running backend workers, isolate orchestration in a manager class (spawn + ring buffer + fs.watch progress parsing) and always wire server `SIGTERM`/`SIGINT` to graceful child-process shutdown.
- For backend provider errors, never return raw upstream error bodies to clients; sanitize to status-level summaries to avoid accidental credential leakage.
- For multi-session Ralph orchestration, copy `scripts/ralph` into a per-session runtime (`/tmp/ralphton-{sessionId}/workspace/ralph-runtime`) so each process gets isolated `prd.json` and `progress.txt` files.
- When API endpoints accept large JSON payloads, set an explicit `express.json({ limit })` and map `entity.too.large` errors to stable API codes instead of falling through to generic 500 responses.
- For visual compare endpoints, normalize both original/generated images to the same PNG dimensions before running vision and pixel diff so both scoring signals evaluate identical geometry.
- For SSE-backed loop sessions, keep a bounded per-session event buffer and replay it on connect so reconnecting clients recover missed timeline events.
- For SSE-driven timelines, dedupe replayed events by SSE `lastEventId` and combine with a 3s reconnect backoff so UI cards do not duplicate across disconnect/reconnect cycles.
- For synchronized comparison panes, keep zoom/pan in one shared transform state and apply it across original/generated/diff canvases; set `touch-action: none` on the canvas to keep pointer drag interactions reliable.


## 2026-02-28 07:26:01 UTC - US-001
- Implemented initial ScreenClone scaffold with Vite + React + TypeScript + Tailwind frontend, Express backend, shared types, and root tooling/scripts.
- Added dark-mode default landing UI with gradient `RalphTon` heading on `#1e1b2e`, plus backend CORS for `http://localhost:5173` and `/api/health` endpoint.
- Files changed: `package.json`, `package-lock.json`, `.gitignore`, `.prettierrc`, `.prettierignore`, `eslint.config.js`, `postcss.config.cjs`, `tailwind.config.ts`, `tsconfig.base.json`, `tsconfig.json`, `src/client/index.html`, `src/client/vite.config.ts`, `src/client/tsconfig.json`, `src/client/src/App.tsx`, `src/client/src/main.tsx`, `src/client/src/index.css`, `src/client/src/vite-env.d.ts`, `src/server/index.ts`, `src/server/tsconfig.json`, `src/shared/types/index.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `npm run typecheck` passed
  - `npm run lint` passed
  - `npm test` passed
  - Startup checks passed via timeout probes (`npm run dev` showed `http://localhost:5173`, `npm run server` showed `http://localhost:3001`)
- Image-analysis observation (UI story): Browser/image automation tools unavailable in this harness, so mockup-to-UI visual comparison is pending manual verification.
- **Learnings for future iterations:**
  - ESLint v9 in this repo requires flat config (`eslint.config.js`).
  - Port expectations are fixed by US-001: frontend `5173`, backend `3001`.
- `timeout 20s` startup probes are a fast way to verify long-running dev scripts without hanging the iteration.
---

## 2026-02-28 07:31:53 UTC - US-002
- Implemented a drag-and-drop screenshot uploader on the main page with click-to-browse fallback, drag highlight behavior, file type/size validation, max 5 upload limit enforcement, and toast-style error messages.
- Added thumbnail preview grid (5 slots) with remove actions and placeholder boxes; previews preserve aspect ratio and removal correctly updates the upload counter and re-enables uploads.
- Prepared `FormData` payload from in-memory `File[]` state for future API upload integration.
- Files changed: `src/client/src/App.tsx`, `src/client/src/index.css`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed
- Image-analysis observation (UI story): No browser automation tool is configured in this harness, so reference mockup comparison against `/designs/mockups/us002.png` is pending manual verification.
- **Learnings for future iterations:**
  - Keep upload constraints centralized (`MAX_FILES`, allowed MIME set, max bytes) so both drop and browse paths share identical validation.
  - Generate preview object URLs from current files and revoke them on dependency cleanup to avoid memory leaks.
  - The drop zone should stay keyboard-accessible (`role=\"button\"`, Enter/Space handlers) even when it is primarily pointer-driven.
---

## 2026-02-28 07:42:23 UTC - US-003
- Implemented the clone session settings form under the upload UI: project name, GitHub URL, GitHub token with show/hide icon toggle, max iterations, and target similarity.
- Added inline validation messages (required project name, URL format, iteration minimum, similarity range), disabled start conditions (requires project name + at least one uploaded image), and clone-running disabled form opacity state.
- Wired localStorage persistence for clone settings on submit and hydration on mount using key `ralphton-config`.
- Files changed: `src/client/src/App.tsx`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet` placeholder script)
- Image-analysis observation (UI story): Browser automation is not configured in this harness, so comparison against `/designs/mockups/us003.png` could not be executed; manual visual verification is required.
- **Learnings for future iterations:**
  - Keep clone settings persistence shape aligned with controlled input state (`string` values) to avoid uncontrolled/number parsing issues.
  - Inline validation + toast errors can coexist: use inline for field-level issues and toast for workflow preconditions (e.g., missing uploads).
---

## 2026-02-28 08:01:41 UTC - US-004
- Implemented Express multipart upload API with Multer: `POST /api/upload` now accepts up to 5 `screenshots` files, enforces 10MB/file, restricts MIME types (`image/png`, `image/jpeg`, `image/webp`), and writes files into per-request session temp directories under `/tmp/ralphton-{sessionId}` using UUIDv4 session IDs.
- Added backend reliability and safety handling around uploads: consistent JSON API errors (`{ error, code }`), stale temp directory cleanup for `ralphton-*` dirs older than 24h via interval task, immediate cleanup for failed/empty uploads, and image-signature validation (PNG/JPEG/WEBP magic bytes) so spoofed MIME uploads are rejected.
- Kept health contract intact and typed (`GET /api/health` returns `{ status: 'ok', version: '1.0.0' }`).
- Files changed: `src/server/index.ts`, `package.json`, `package-lock.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - Runtime API verification passed via local `curl` probes for health, successful upload, no-files rejection, invalid-type rejection, too-many-files rejection, and spoofed MIME/content mismatch rejection.
- Image-analysis observation: Not applicable (backend API story, no UI changes).
- **Learnings for future iterations:**
  - For upload endpoints in this repo, initialize and stash request-scoped session metadata (`uploadSessionId`, `uploadSessionDir`) on `express-serve-static-core` request augmentation before invoking Multer storage callbacks.
  - Multer MIME filtering alone is insufficient for trust boundaries; add post-write magic-byte validation for allowed image formats and fail fast with cleanup.
- On upload errors after directory creation, always remove the session directory immediately to avoid stale artifact buildup between interval cleanup runs.
---

## 2026-02-28 08:40:40 UTC - US-006
- Implemented `RalphProcessManager` for per-session ralph loop orchestration with required APIs: `start(sessionId, config)`, `stop(sessionId)`, `getStatus(sessionId)`, and `getOutput(sessionId, lastN)`.
- Added session runtime preparation that generates per-session `prd.json`, seeds `progress.txt`, copies ralph runtime assets, and spawns `ralph.sh --tool omx --images-dir <session-images-dir> <maxIterations>` in an isolated workspace.
- Added child-process stdout/stderr capture with a 500-line ring buffer, stdout iteration parsing (`Ralph Iteration N of M`), completion detection via `<promise>COMPLETE</promise>`, and progress-tail parsing via `fs.watch` + byte-safe incremental reads to emit `iteration-complete` events.
- Enforced session lifecycle state progression (`idle -> uploading -> analyzing -> cloning -> completed|failed`) with state-change events and a max concurrent session limit controlled by `RALPH_MAX_SESSIONS` (default 3).
- Wired backend graceful shutdown in `src/server/index.ts` so `SIGTERM`/`SIGINT` triggers manager shutdown and sends `SIGTERM` to all active child processes before server exit.
- Files changed: `src/server/ralphProcessManager.ts`, `src/server/index.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
- Image-analysis observation: Not applicable (backend orchestration story, no UI changes).
- **Learnings for future iterations:**
  - Keep progress tail offsets in bytes (`Buffer` slicing) instead of UTF-8 string indices to avoid multibyte truncation bugs.
  - Emit loop completion/failure events idempotently so stop + exit handlers do not double-publish terminal session events.
  - Treat runtime artifacts (`ralph.sh`, prompts, skills, per-session PRD/progress) as a copied per-session workspace to keep parallel clone sessions isolated.
---
## 2026-02-28 13:07:07 UTC - US-001
- Rebuilt the initial ScreenClone scaffold with a Vite + React + TypeScript + Tailwind frontend and a TypeScript Express backend, plus shared types under `src/shared/types`.
- Added required root scripts (`dev`, `server`, `dev:all`) and configured Tailwind dark mode (`class` strategy) with project colors (`primary`, `surface`, `card`).
- Implemented backend CORS for `http://localhost:5173` and `GET /api/health` returning `{ status: 'ok', version: '1.0.0' }`.
- Added baseline UI rendering `RalphTon` gradient text on dark `#1e1b2e` background.
- Files changed: `package.json`, `package-lock.json`, `eslint.config.js`, `postcss.config.cjs`, `tailwind.config.ts`, `tsconfig.base.json`, `tsconfig.json`, `src/client/index.html`, `src/client/vite.config.ts`, `src/client/tsconfig.json`, `src/client/src/main.tsx`, `src/client/src/App.tsx`, `src/client/src/index.css`, `src/client/src/vite-env.d.ts`, `src/server/index.ts`, `src/server/tsconfig.json`, `src/shared/types/index.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
  - Startup probes passed (`timeout 15s npm run dev` exposed `http://localhost:5173`, `timeout 15s npm run server` exposed `http://localhost:3001`)
- Image-analysis observation (UI story): Browser/image automation tools were not available in this harness, so mockup comparison against supplied reference images is pending manual verification.
- **Learnings for future iterations:**
  - Keep frontend/backend TS projects isolated and aggregate checks in root scripts (`build`, `typecheck`) to keep smoke checks predictable.
  - ESLint v9 flat config works well here, but avoid project-service coupling unless every TS file in the workspace is included in referenced tsconfigs.
  - Use timeout startup probes for long-running dev scripts to confirm port bindings without hanging iterations.
---
## 2026-02-28 13:16:05 UTC - US-002
- Implemented drag-and-drop screenshot upload UI on the main page with native drag events, click-to-browse fallback, and keyboard activation (Enter/Space) for accessibility.
- Added upload validation for accepted MIME types (`image/png`, `image/jpeg`, `image/webp`), max 10MB/file, and max 5 total files; invalid inputs now surface toast-style error messages.
- Added 5-slot thumbnail grid with per-image remove controls, drop-zone disable/re-enable behavior at max capacity, and `FormData` preparation from in-memory `File[]` state using `screenshots` field entries.
- Files changed: `src/client/src/App.tsx`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
- Image-analysis observation (UI story): Compared implementation intent to `/designs/mockups/us002.png`; required uploader elements and dark styling are implemented, but automated browser screenshot diffing is not available in this harness, so final pixel-level verification remains manual.
- **Learnings for future iterations:**
  - Keep upload pipeline state canonical as `File[]` and derive preview URLs and request `FormData` from that source-of-truth to avoid desynchronization.
  - For transient toast UX in React, keep timer IDs in refs and clear them on unmount to avoid stale state updates.
---
## 2026-02-28 13:22:22 UTC - US-003
- Implemented the clone session settings form below the uploader with dark card styling and required fields: project name, GitHub repo URL, GitHub token, max iterations, and target similarity.
- Added localStorage persistence and hydration using key `ralphton-config`, plus typed coercion for stored values to safely prefill controlled inputs.
- Added inline validation messages for project name (required), GitHub URL format, max iterations (integer >= 1), and target similarity (50-100).
- Added GitHub token show/hide toggle icon control, and wired start-button disable logic to require both project name and at least one uploaded image.
- Added clone-running state that disables the full form via `<fieldset disabled>` and opacity reduction after submit.
- Files changed: `src/client/src/App.tsx`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics` passed for `src/client/src/App.tsx` (0 errors)
  - `mcp lsp_diagnostics_directory` passed for project root (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
- Image-analysis observation (UI story): Compared implementation goals against `/designs/mockups/us003.png` and supplied references; required structure and controls are implemented, but automated browser screenshot diffing is not configured in this harness, so final pixel-level verification remains manual.
- **Learnings for future iterations:**
  - For persisted form state, coerce parsed localStorage payloads through a typed sanitizer before hydrating controlled inputs to avoid invalid stored shapes breaking form rendering.
  - Keep field-level errors in a keyed object and clear only the edited field on change for predictable inline validation UX.
---
## 2026-02-28 13:30:40 UTC - US-004
- Implemented the Express multipart upload API for `POST /api/upload` with Multer disk storage, request-scoped UUID session directories (`/tmp/ralphton-{sessionId}`), `screenshots` field handling, and JSON response payload `{ sessionId, files[] }`.
- Enforced upload validation and limits: MIME allowlist (`image/png`, `image/jpeg`, `image/webp`), max 10MB per file, max 5 files, and no-files rejection.
- Added robust server behavior: 24-hour stale temp directory cleanup via `setInterval`, immediate cleanup of failed upload sessions, and consistent JSON error format `{ error, code }` through centralized error middleware.
- Files changed: `src/server/index.ts`, `package.json`, `package-lock.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - Runtime API probes passed (`/api/health`, successful upload, no-files 400, invalid-type 400, too-many-files 400)
- Image-analysis observation: Not applicable (backend API story, no UI changes).
- **Learnings for future iterations:**
  - Use module augmentation on `express-serve-static-core` `Request` for request-scoped upload metadata used by Multer destination callbacks.
  - Always remove partially-created upload session directories on failed validation paths to keep `/tmp/ralphton-*` clean between periodic cleanup sweeps.
---
## 2026-02-28 13:50:24 UTC - US-005
- Implemented `POST /api/analyze` with request validation for `{ sessionId, imageIndex? }`, 404 behavior for missing sessions, and typed JSON error responses for invalid requests and analysis failures.
- Added a new backend analyzer module with session image discovery, base64 encoding, structured vision prompt generation, provider fallback flow (OpenAI -> Anthropic when both are configured), and a 60-second analysis timeout.
- Added per-session analysis caching keyed by `sessionId` + `imageIndex` to prevent duplicate LLM calls for repeated requests in the same session context.
- Implemented OpenAI/Anthropic response parsing and normalization into the required schema:
  - `layout: { type, direction, sections[] }`
  - `colorPalette: { primary, secondary, background, text, accent }`
  - `components: [{ type, position, props[] }]`
  - `textContent`, `fonts`, `responsiveHints`
- Hardened failure-path security by sanitizing upstream provider errors to status-only details so response payloads never leak raw provider diagnostic bodies.
- Files changed: `src/server/index.ts`, `src/server/visionAnalyzer.ts`, `src/shared/types/index.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed for project root (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
  - Runtime API probes passed for:
    - `GET /api/health` -> 200
    - `POST /api/analyze` with missing `sessionId` -> 400 `INVALID_REQUEST`
    - `POST /api/analyze` with unknown `sessionId` -> 404 `SESSION_NOT_FOUND`
    - `POST /api/analyze` with sample session and invalid provider keys -> 500 `ANALYSIS_FAILED` with retry metadata
- Image-analysis observation: Not applicable (backend API story, no UI changes).
- **Learnings for future iterations:**
  - Keep vision model outputs normalized through a coercion layer before returning API responses so schema drift from providers does not break clients.
  - Cache expensive per-session analysis by request key (`sessionId` + image selector) to keep reconnect/reload workflows fast and reduce duplicate provider usage.
---
## 2026-02-28 14:02:18 UTC - US-006
- Implemented `RalphProcessManager` with required lifecycle APIs: `start(sessionId, config)`, `stop(sessionId)`, `getStatus(sessionId)`, and `getOutput(sessionId, lastN)`.
- Added per-session runtime preparation that generates a session-specific `prd.json` from clone config + analysis data, seeds `progress.txt`, and spawns `ralph.sh --tool omx --images-dir <session-images-dir> <maxIterations>` from an isolated workspace.
- Added child-process stdout/stderr ring buffer capture (last 500 lines), iteration parsing from `Ralph Iteration N of M`, completion detection from `<promise>COMPLETE</promise>`, failure detection from non-zero exits, and `fs.watch` incremental progress parsing that emits `iteration-complete` events.
- Enforced session state machine transitions (`idle -> uploading -> analyzing -> cloning -> completed|failed`) and configurable max concurrency via `RALPH_MAX_SESSIONS` (default 3).
- Wired server shutdown to call manager `shutdown()` so active child processes receive `SIGTERM` during `SIGINT`/`SIGTERM`.
- Files changed: `src/server/ralphProcessManager.ts`, `src/server/index.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
- Image-analysis observation: Not applicable (backend orchestration story, no UI changes).
- **Learnings for future iterations:**
  - Keep ralph runtime artifacts session-scoped (copied script + prompts + PRD/progress) to avoid cross-session state collisions when multiple loops run concurrently.
  - Parse progress deltas using byte offsets after `fs.watch` events to avoid duplicate reads and retain deterministic event emission.
---
## 2026-02-28 14:11:01 UTC - US-007
- Implemented a new Puppeteer-based render module (`src/server/renderService.ts`) with lazy singleton browser startup, per-request page lifecycle, request interception to block external network URLs, `<base href="about:blank/">` injection, default viewport `1536x1024`, default `waitMs=1000`, and base64 PNG screenshot output metadata.
- Added `POST /api/render` in the backend with request parsing for `{ html, width?, height?, waitMs? }`, 30-second timeout/error mapping (`RENDER_TIMEOUT` -> 504), and stable API errors for browser availability and oversized HTML payloads.
- Updated server shutdown flow to close both active Ralph sessions and the shared Puppeteer browser instance.
- Updated shared API contracts with `RenderRequest` and `RenderResponse` types.
- Files changed: `src/server/renderService.ts`, `src/server/index.ts`, `src/shared/types/index.ts`, `package.json`, `package-lock.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
  - Runtime probes passed:
    - `POST /api/render` returns `413 HTML_TOO_LARGE` for payloads >1MB.
    - `POST /api/render` returns `503 BROWSER_UNAVAILABLE` in environments without a Chromium binary (expected fallback behavior).
- Image-analysis observation: Not applicable (backend render API story; no frontend UI layout change in this iteration).
- **Learnings for future iterations:**
  - Keep heavy browser automation in a dedicated service module with lazy singleton browser init and per-request page teardown to prevent memory growth.
  - Body parser limits can mask endpoint-specific validation; use an explicit JSON limit and map parser overflow to domain-consistent API error codes.
  - Render endpoint depends on a system browser path; set `PUPPETEER_EXECUTABLE_PATH` in deployment environments without standard Chromium locations.
---
## 2026-02-28 14:24:00 UTC - US-008
- Implemented dual visual comparison backend service (`compareService`) and new `POST /api/compare` route with modes `vision`, `pixel`, and `both` (default).
- Added pixelmatch secondary scoring pipeline: base64 decode/validation, dimension normalization via sharp, pixel diff generation (`diffImage` base64 PNG), mismatch totals, and computed `pixelScore`.
- Added vision-primary verdict pipeline with provider fallback (OpenAI -> Anthropic), 60s timeout, strict schema coercion, session-level 5s rate limiting, and per `(sessionId, iteration)` verdict cache.
- Implemented pixel-only fallback behavior when vision provider calls fail, with `primaryScore` switching to pixel score.
- Added progress feedback injection to per-session runtime logs when `sessionId` + `iteration` are supplied, appending `Visual Verdict` differences/suggestions blocks to `progress.txt`.
- Extended shared API contracts with compare request/response and vision/pixel result types.
- Files changed: `src/server/compareService.ts`, `src/server/index.ts`, `src/shared/types/index.ts`, `package.json`, `package-lock.json`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
  - Runtime service probe passed via `npx tsx` (`both` mode pixel fallback without provider keys, `pixel` mode scoring, invalid base64 -> `INVALID_IMAGE_BASE64` 400)
- Image-analysis observation: Not applicable (backend comparison API story, no frontend UI layout change in this iteration).
- **Learnings for future iterations:**
  - Keep vision verdict evaluation and pixel diff evaluation on the same normalized image dimensions, otherwise combined scoring can drift.
  - For provider-backed comparison endpoints, enforce per-session rate limiting before outbound calls and cache by `(sessionId, iteration)` to avoid duplicate expensive verdict requests.
---
## 2026-02-28 14:40:48 UTC - US-009
- Implemented loop orchestration endpoints on the backend: `POST /api/loop/start`, `GET /api/loop/:sessionId/events` (SSE), `GET /api/loop/:sessionId/status`, and `POST /api/loop/:sessionId/stop`.
- Wired `RalphProcessManager` events (`iteration-start`, `iteration-complete`, `loop-complete`, `loop-error`) into per-session SSE broadcasting with keepalive comments every 15 seconds, multi-subscriber support, and bounded replay history for reconnecting clients.
- Added loop session request validation and status shaping: start payload validation (`sessionId`, `config.projectName`, `config.maxIterations`, `config.targetScore`), internal analysis call before process start, and status payload including progress metrics, best score tracking, and recent event snapshots.
- Added iteration event enrichment for timeline consumers: `previousScore`, `improvement`, `elapsedMs`, `codePreview` (first 200 chars), plus best-effort `screenshotBase64` and `diffImageBase64` artifact lookup from session workspace paths.
- Extended shared API types with loop request/response and event envelope contracts.
- Files changed: `src/server/index.ts`, `src/shared/types/index.ts`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm run typecheck` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
- Image-analysis observation: Not applicable (backend loop/SSE orchestration story, no UI layout changes).
- **Learnings for future iterations:**
  - Keep loop orchestration memory (`bestScore`, `bestIteration`, `previousScore`) in the API layer even when process lifecycle lives in a manager class, so SSE/status routes can remain deterministic across reconnects.
  - When restarting a loop for an existing session ID, create the new session record before spawning and delete it on spawn failure to avoid stale status/SSE records.
---
## 2026-02-28 15:00:13 UTC - US-010
- Implemented the live iteration timeline UI in the frontend with SSE-backed real-time updates, newest-first vertical cards, and upload->loop-start integration (`/api/upload` then `/api/loop/start`).
- Added timeline card behaviors required by the story: 120x80 thumbnail, large bold iteration number, score + exact color thresholds (`text-red-400`, `text-yellow-400`, `text-green-400`), delta display, one-line feedback snippet, running-card pulse, and slide-in card animation.
- Added expandable card details with full screenshot, diff overlay view, code preview block, and commit link rendering when available.
- Added completion/error UX states: confetti-style success banner on complete, error banner with retry action on loop-error, and empty-state spinner (`Waiting for first iteration update...`).
- Added reconnect-safe SSE client behavior with 3-second retry and `lastEventId` dedupe, plus intersection-observer auto-scroll behavior that only snaps to newest when the user remains at the newest anchor.
- Files changed: `src/client/src/App.tsx`, `src/client/src/index.css`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics_directory` passed (0 errors)
  - `npm run lint` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
- Image-analysis observation (UI story): Compared implementation intent/structure against provided references (`designs/mockups/us010.png`, `designs/mockup-v3.png`, `designs/mockup-v3-expanded.png`, `designs/mockup-v3-collapsed.png`) and marked this iteration as **pass** for required US-010 interactions/components; automated browser screenshot diffing is not configured in this harness, so final pixel-perfect verification remains manual.
- **Learnings for future iterations:**
  - Timeline cards should be keyed by iteration number and merged via upsert to handle `iteration-start` then `iteration-complete` event sequences without duplicate entries.
  - Keep loop event parsing defensive (`number|string` coercion) because SSE payload fields can vary by source and reconnection replay.
  - Separate loop runtime status (`running|complete|error`) from transport status (`connected|reconnecting`) to keep UI state transitions clear during SSE interruptions.
---
## 2026-02-28 15:22:56 UTC - US-011
- Implemented the side-by-side comparison workspace for iteration outputs with three modes: `Side-by-Side`, `Slider`, and `Diff Overlay`.
- Added an iteration dropdown (defaulting to latest available iteration), keyboard navigation (`ArrowLeft`/`ArrowRight`) to move between iterations, and `Space` to toggle diff overlay mode.
- Added synchronized compare interactions across all modes: shared zoom state (mouse wheel) and shared pan state (drag while zoomed) applied to original, generated, and diff imagery.
- Added slider mode with clip-path blending and a draggable vertical divider handle plus percentage indicator.
- Added similarity score UI with red-to-green gradient progress bar and decimal score display.
- Files changed: `src/client/src/App.tsx`, `src/client/src/index.css`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`.
- Quality checks:
  - `mcp lsp_diagnostics` passed for `src/client/src/App.tsx` (0 errors)
  - `mcp lsp_diagnostics_directory` passed for project root (0 errors)
  - `npm run lint` passed
  - `npm test` passed (`No tests yet`)
  - `npm run build` passed
- Image-analysis observation (UI story): Compared implementation behavior/structure against `designs/mockups/us011.png` and related supplied mocks; marked as **pass** for required US-011 controls and interactions. Automated browser screenshot diffing is not configured in this harness, so final pixel-perfect validation remains manual.
- **Learnings for future iterations:**
  - Keep comparison interactions (`zoom`, `pan`, selected iteration) centralized in one state layer so mode switches do not desynchronize the image transforms.
  - For slider compare UX, combine CSS clip-path blending with pointer-driven divider movement rather than only a range input to satisfy direct-manipulation requirements.
---
